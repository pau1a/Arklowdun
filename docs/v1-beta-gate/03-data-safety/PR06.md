# PR-06: Export Package (data + attachments + manifest)

## Title
Implement a user-facing export package containing all data, attachments, and a manifest with checksums for verifiable round-trips.

---

## Problem
Backups (PR-03) and Repairs (PR-04/05) protect the local DB, but users need the ability to **take their data out** in a portable, verifiable format.  
Export must include structured data, attachments, and integrity metadata, so that re-import (PR-07) and external verification are possible.

---

## Scope
### Export Structure
- Root folder (user-chosen location):
```

export-YYYYMMDD-HHMMSS/
manifest.json
data/
households.jsonl
events.jsonl
notes.jsonl
files.jsonl
attachments/
\<household\_id>/\<attachment\_id>.<ext>
verify.sh / verify.ps1

````

### Manifest
- JSON file containing:
```json
{
  "app_version": "0.1.0",
  "schema_version": "0001_baseline",
  "created_at": "2025-09-23T12:00:00Z",
  "tables": {
    "households": { "count": 2, "sha256": "…" },
    "events": { "count": 10000, "sha256": "…" },
    "notes": { "count": 5000, "sha256": "…" }
  },
  "attachments": {
    "total_count": 300,
    "total_bytes": 524288000,
    "sha256_manifest": "…"
  }
}
````

* `sha256_manifest` is the checksum of a file listing all attachment paths + hashes.

### Export Process

1. Preflight checks:

   * Free disk space ≥ estimated export size.
   * Write permission to target directory.
2. Dump each table to `.jsonl` file (line-delimited JSON).
3. Copy attachments into `attachments/` tree with original IDs/filenames.
4. Compute SHA256 for each table file and attachments manifest.
5. Write `manifest.json` and verification script.

### Verification Script

* **verify.sh** (bash) and **verify.ps1** (PowerShell).
* Recompute SHA256 of data + attachments and compare to manifest.
* Exit 0 if all OK; non-zero otherwise.

### UI Surface

* Settings → “Export Data”:

  * Button to choose target directory.
  * Preflight estimate of space required.
  * Progress bar with counts (tables, attachments).
  * On success: toast *“Export complete (524 MB)”* with “Reveal” + “Verify” options.

### CLI Surface

* Command: `arklowdun db export --out <path>`

  * Prints progress to STDOUT.
  * On success, prints path to manifest and verification script.

---

## Acceptance Criteria

* Export always produces a deterministic directory (ordering stable, hashes stable).
* `verify.sh` and `verify.ps1` succeed on a fresh machine with no app dependencies.
* Export fails gracefully if space is insufficient or permission denied.
* Tests:

  * Small DB → manifest counts correct.
  * Large DB (10k+ events, 5k+ notes) → export completes within budget, manifest valid.
  * Unicode paths/filenames succeed.
  * Attachments with missing files → logged in manifest as “missing”.

---

## Non-Goals / Out of Scope

* Import workflows (PR-07).
* Cloud sync/export destinations.
* Compression of export bundle (manual only).

---

## Risks & Mitigations

* **Large attachments**: risk of long export times.

  * Mitigation: chunk copy with progress updates.
* **Filesystem quirks**: long paths, unicode names.

  * Mitigation: normalise separators, test on Windows/Linux/macOS.
* **Verification drift**: ensure verify scripts use same algorithm (sha256sum / Get-FileHash -Algorithm SHA256).

---

## Deliverables

* `src-tauri/src/export/mod.rs` (engine).
* `src-tauri/src/export/manifest.rs` (manifest builder + sha256 utils).
* UI: `ExportView.tsx` under Settings.
* CLI: `arklowdun db export --out <path>`.
* Scripts: `verify.sh`, `verify.ps1` included in export folder.
* Tests:

  * Unit: manifest generation, sha256 correctness.
  * Integration: export fixture DB and validate counts/hashes.
  * E2E: run verify.sh/ps1 on exported bundle.

---

## Exit Condition

* Users can export all data + attachments into a portable, verifiable package.
* Manifest guarantees integrity and completeness.
* Verification scripts prove export correctness outside the app.
