# PR-08: Round-Trip CI Fixture (export → wipe → import → verify)

## Title
Automate a large-scale round-trip test in CI to prove export/import integrity and stability.

---

## Problem
Manual tests and small fixtures don’t catch scale bugs, ordering drift, or nondeterministic behaviour.  
We need a **repeatable CI pipeline** that seeds a large dataset, exports it, wipes the DB, re-imports, and verifies equivalence—failing the build on any mismatch.

---

## Scope
### Canonical Large Fixture
- Add a deterministic data generator or a static fixture with:
  - **≥ 10,000 events**, **≥ 5,000 notes**, **≥ 300 attachments** across ≥ 2 households.
  - Realistic mixes: timed/all-day events, RRULEs with EXDATEs, deleted/restored flags, soft-delete cases.
  - Attachments: small (≤100 KB) and medium (≤5 MB) files; a few unicode filenames.
- Store as scripts + seeds, not as a massive binary blob:
  - `fixtures/large/seed.ts` (or Rust) to build the DB from scratch.
  - `fixtures/large/attachments/` with a modest corpus reused via generator (copied multiple times with different IDs).

### CI Job: Round-Trip
A single workflow that performs:

1) **Build app/CLIs** (release profile).
2) **Seed DB** using the large fixture (produces `arklowdun.sqlite3` in the app data dir).
3) **Export** via PR-06 to a temp directory (capture manifest + checksums).
4) **Wipe** the live DB (remove file and attachments tree).
5) **Import** via PR-07 from the export bundle.
6) **Verify**:
   - Counts per table match the pre-export counts.
   - Deterministic **sample hashes** (e.g., N canonical records) match.
   - Attachments count and total bytes match; spot-check M random attachments’ SHA256.
   - DB health (PR-01) returns OK.
7) **Publish artifacts** on failure:
   - Export manifest, import report, diff report, operation reports, and CI logs.

### Determinism & Budgets
- All generators must be seeded (`--seed 42`) for stable data.
- Ordering of JSONL exports and inserts must be deterministic.
- Define time budgets per step with soft warnings and a hard fail ceiling (e.g., total ≤ 12 min on GH ubuntu-latest).

### Diff Report
- Produce `roundtrip-diff.json` on any mismatch:
  ```json
  {
    "tables": {
      "events": { "expected": 10000, "actual": 9998, "missing_ids": ["..."], "extra_ids": [] },
      "notes": { "expected": 5000, "actual": 5000 }
    },
    "attachments": {
      "expected_count": 300,
      "actual_count": 300,
      "expected_bytes": 524288000,
      "actual_bytes": 524288000,
      "sample_mismatches": []
    },
    "health_ok": false
  }
````

* Save to CI artifacts with manifest and reports.

---

## Acceptance Criteria

* CI executes export → wipe → import → verify on every push to protected branches (and on PRs).
* When everything is correct:

  * Counts match for all tables; health = OK; attachments counts/bytes match; sample hashes match.
  * Job completes within the defined budget.
* On any discrepancy:

  * CI fails; artifacts contain manifest, import/export reports, and `roundtrip-diff.json`.
* Local developer run: a single script reproduces the CI flow on a workstation (without CI secrets).

---

## Non-Goals / Out of Scope

* Performance gating (that’s for the Perf/UX track).
* Cloud storage of artifacts beyond standard CI retention.
* Schema-migration compatibility (round-trip assumes identical schema).

---

## Risks & Mitigations

* **CI runtime bloat**: cap dataset to meaningful-but-manageable size, use release builds, cache dependencies.
* **Flaky nondeterminism**: seed all randomness, sort exports, explicit stable ordering for inserts.
* **Big artifacts**: on success, do not upload; on failure, upload only minimal diffs + manifests.

---

## Deliverables

* `fixtures/large/seed.(ts|rs)` — deterministic large-data seeder.
* `scripts/roundtrip.sh` — local runner: build → seed → export → wipe → import → verify.
* `scripts/roundtrip-verify.ts` (or rs) — counts + sample-hash verification and diff report.
* `.github/workflows/roundtrip.yml` — CI workflow with matrix for macOS/Windows/Linux (optional start with Linux).
* `docs/dev/roundtrip.md` — how to run locally, expected outputs, troubleshooting.

---

## CI Workflow Outline (`.github/workflows/roundtrip.yml`)

* Triggers: `pull_request`, `push` to `main`, manual `workflow_dispatch`.
* Steps:

  1. Checkout, set up toolchains.
  2. Build app/CLI (release).
  3. `scripts/roundtrip.sh --seed 42 --tmp "$RUNNER_TEMP/rt"`:

     * seed → export → wipe → import → verify
  4. On failure: `actions/upload-artifact` with `roundtrip-diff.json`, manifest, import/export reports, logs.

---

## Verification Rules

* **Counts:** exact equality per table.
* **Sample hashes:** compute SHA256 of a canonical subset (e.g., first 100 event IDs by stable sort) from both pre-export and post-import databases.
* **Attachments:** exact count and byte totals; random sample of 10 files’ hashes must match.
* **Health:** PR-01 report returns `status=ok`.

---

## Exit Condition

* A single CI job proves that a large dataset can be exported and re-imported **without loss or drift**.
* Any drift fails the build with actionable artefacts.
* Developers can run the same round-trip locally with one command.
