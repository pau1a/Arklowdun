# PR-03: One-Click Backup + Retention

## Title
Implement atomic SQLite snapshot backups with manifest and retention, surfaced via UI and CLI.

---

## Problem
Detecting corruption (PR-01) and blocking writes (PR-02) only protect the present state.  
We need a reliable way to capture a **safe snapshot** of the database before any risky operation (e.g., repair, import).  
Backups must be atomic, verifiable, and manageable (no unbounded growth).

---

## Scope
### Backup Operation
- Use SQLite backup API (`sqlite3_backup`) or `VACUUM INTO` to produce a consistent copy of the live DB without downtime.
- Destination:  
```

\$APPDATA/arklowdun/backups/YYYYMMDD-HHMMSS/arklowdun.sqlite3

````
- Alongside DB file, generate a `manifest.json`:
```json
{
  "app_version": "0.1.0",
  "schema_hash": "abc123",
  "db_size_bytes": 1234567,
  "created_at": "2025-09-23T10:42:00Z",
  "sha256": "…"
}
````

### Retention Policy

* Default: keep **last 5 snapshots** or total ≤ **2 GB**.
* Oldest-first eviction when limit reached.
* Configurable via env vars:

  * `ARK_BACKUP_MAX_COUNT` (default 5)
  * `ARK_BACKUP_MAX_BYTES` (default 2\_000\_000\_000)

### UI Surface

* Settings → “Backups” section:

  * Button: “Create Backup” (disabled if <100 MB disk space available).
  * After success: toast *“Backup created (142 MB)”* with actions “Reveal” and “Copy path”.
  * List last 5 backups with size/date and “Reveal”.
* Failure messages:

  * “Not enough disk space (need \~350 MB).”
  * “Permission denied writing to backups folder.”

### CLI Surface

* Command: `arklowdun db backup`

  * Creates snapshot under default path.
  * Prints manifest info to STDOUT.
  * Exit code 0 on success; non-zero on failure.

---

## Acceptance Criteria

* Snapshot is atomic: no partial file visible mid-operation.
* DB can be in active use; snapshot still consistent.
* Manifest produced for every backup; sha256 verifies DB file integrity.
* Retention enforced automatically on success.
* Tests:

  * Healthy DB → backup produced, manifest correct.
  * Low disk simulation → fails gracefully with clear message.
  * Long path names/unicode paths succeed.
  * Locked DB does not break snapshot.

---

## Non-Goals / Out of Scope

* Repair workflows (PR-04/05).
* Export/import (PR-06/07).
* Cloud or remote backup destinations.

---

## Risks & Mitigations

* **Disk space exhaustion**: preflight check ensures free space ≥ current DB size × 1.2.
* **Performance impact**: backup runs in background thread; UI shows spinner if >1s.
* **Retention misconfiguration**: enforce hard caps even if env vars mis-set.

---

## Deliverables

* `src-tauri/src/db/backup.rs` (backup + manifest writer).
* `src-tauri/src/db/manifest.rs` (schema hash + sha256 util).
* UI: `BackupView.tsx` in Settings.
* CLI: `arklowdun db backup` command.
* Tests:

  * Unit: manifest creation, retention pruning.
  * Integration: atomic snapshot visible after operation only.
  * E2E: UI backup produces file with correct manifest.

---

## Exit Condition

* Users can create a verifiable backup with one click or CLI command.
* Retention works automatically.
* Manifest guarantees file integrity.
* Backup always succeeds or fails cleanly—never leaves partial/corrupt files.
