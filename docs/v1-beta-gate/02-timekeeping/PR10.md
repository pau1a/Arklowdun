# PR-10 Mandate — EXDATE Normalisation

## Objective
Introduce strict **normalisation rules** for EXDATE values to guarantee correctness, deduplication, and consistent formatting.  
Ensure malformed EXDATEs are rejected with actionable errors instead of being silently ignored.

---

## Scope
- Implement normalisation of EXDATE input and storage:
  - Parse incoming values into canonical UTC timestamps (ISO-8601 format with `Z` suffix).
  - Sort values chronologically before storage.
  - Deduplicate repeated entries.
- Strict parsing rules:
  - Reject invalid formats (non-ISO dates, missing Z).
  - Reject entries that fall outside the event’s recurrence window with a clear warning.
- Migration logic:
  - Detect and clean existing malformed or duplicate EXDATEs in DB.
  - Write them back in canonicalised, deduplicated order.
- Update backend API:
  - All IPC/CLI surfaces return EXDATEs in the normalised format only.
- Add documentation:
  - `/docs/exdate-normalisation.md` describing canonical form, rules, and rationale.

---

## Non-Goals
- No RDATE support (future PR).  
- No UI polish — only minimal adjustments to surface new error messages where EXDATEs fail validation.  
- No recurrence expansion changes beyond respecting normalised EXDATEs.  

---

## Acceptance Criteria
1. **Canonical Format:** All stored EXDATEs use ISO-8601 UTC with `Z`.  
2. **Deduplication:** Duplicate EXDATE values eliminated during migration.  
3. **Sorting:** EXDATE arrays stored in ascending UTC order.  
4. **Strict Validation:** Invalid EXDATEs rejected with error code + descriptive message.  
5. **Error Handling:** Malformed values skipped safely; skipped count logged.  
6. **Migration Success:** Existing DB upgraded; malformed EXDATEs corrected, invalid entries logged.  
7. **API Consistency:** IPC/CLI responses show only canonicalised EXDATEs.  
8. **Docs Published:** `/docs/exdate-normalisation.md` contains clear guidance and examples.

---

## Evidence Required in PR
- **Before/After Migration:** Example DB with duplicates + malformed EXDATEs → migration cleans and normalises.  
- **CLI/API Demo:** Output showing deduped, ordered, canonical EXDATEs.  
- **Error Handling Demo:** Input with invalid format → error message logged, operation fails cleanly.  
- **Unit Tests:** Cases for duplicates, ordering, invalid format, and cross-boundary dates.  
- **Doc Proof:** `/docs/exdate-normalisation.md` committed with rules + sample inputs/outputs.

---

## Rollback Plan
- Disable EXDATE normalisation logic by reverting the parser and storage changes.  
- Delete migration script; legacy behaviour restored.  
- Rollback does not impact schema but would reintroduce inconsistencies.  

---

## PR Title / Description
- **Title:** `feat(exdate): normalise, deduplicate, and validate EXDATE values`  
- **Body:** Must include Objective, Scope, Non-Goals, Acceptance Criteria, Evidence, and Rollback.

---
```
