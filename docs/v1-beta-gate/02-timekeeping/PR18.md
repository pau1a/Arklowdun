# PR-18 Mandate — Regression Guard in CI for Query Performance

## Objective
Introduce a lightweight **CI guard** that continuously monitors query performance for `events_list_range` on small fixture datasets.  
Ensure regressions are detected early without blocking merges on minor fluctuations.

---

## Scope
- **CI Job:**
  - Add job `gate/query-perf-smoke` to run on every PR and main branch push.
  - Use a 1k-event fixture database generated deterministically.
  - Run `events_list_range` queries for day, week, and month windows.
- **Thresholds:**
  - Loose upper bounds (e.g., 500 ms for any query on 1k dataset).
  - If exceeded, log a warning but do not fail the build.
- **Artifacts:**
  - Store JSON log of query timings (min, max, P50, P95).
  - Upload as CI artifact for inspection.
- **Documentation:**
  - Add `/docs/query-perf-guard.md` describing job purpose, thresholds, and triage steps.
  - Clarify that this guard is **warning-only** in v1, upgradeable to hard fail later.

---

## Non-Goals
- No optimisation of queries (measurement only).  
- No enforcement of strict performance budgets — this PR detects, not blocks.  
- No user-facing impact; all changes live in CI/dev tooling.  

---

## Acceptance Criteria
1. **Job Runs:** `gate/query-perf-smoke` executes on all PRs and pushes to main.  
2. **Fixture Use:** Job uses 1k deterministic event fixture; results reproducible.  
3. **Metrics Captured:** Logs include min, max, P50, P95 timings.  
4. **Threshold Check:** If query > 500 ms, job logs warning but passes.  
5. **Artifact Upload:** Timing log stored as artifact.  
6. **Documentation:** `/docs/query-perf-guard.md` committed with clear instructions.  
7. **Repeatability:** Two consecutive runs on same commit produce results within ±15%.  

---

## Evidence Required in PR
- **CI Log (Pass):** Example run where all queries < 500 ms, logs show timings.  
- **CI Log (Warn):** Example run where one query > 500 ms → warning emitted, job passes.  
- **Artifact Proof:** Uploaded JSON artifact with timing data.  
- **Doc Proof:** `/docs/query-perf-guard.md` included with details and screenshots.  

---

## Rollback Plan
- Remove `gate/query-perf-smoke` job from CI workflow.  
- Delete fixture and timing log scripts.  
- Remove `/docs/query-perf-guard.md`.  
- Leaves query performance unmonitored in CI, but no runtime changes.  

---

## PR Title / Description
- **Title:** `ci(query-perf): add smoke guardrail for query latency with warning-only thresholds`  
- **Body:** Must include Objective, Scope, Non-Goals, Acceptance Criteria, Evidence, and Rollback.

---
```
