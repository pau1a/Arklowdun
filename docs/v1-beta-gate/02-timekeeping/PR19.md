# PR-19 Mandate — Shadow-Read Window + Feature Flag

## Objective
Introduce a **shadow-read mechanism** where both legacy and new UTC columns are consulted during a transitional window.  
Provide a **feature flag** to toggle between dual-read mode and new-only mode, enabling safe validation before final cutover.

---

## Scope
- **Shadow-Read Logic:**
  - Modify event query functions (`events_list_range`, etc.) to read from both legacy wall-clock columns and new UTC columns.
  - Compare values silently; return results from the new UTC columns by default.
  - Log any discrepancies for operator review.
- **Feature Flag:**
  - Add environment variable `ARK_TIME_SHADOW_READ=on|off` (default: `on` for transitional period).
  - When `on`: shadow-read logic enabled, logs discrepancies.
  - When `off`: queries only use new UTC columns, legacy ignored.
- **Discrepancy Logging:**
  - Structured log entries with event ID, household ID, legacy value, new value, and delta.
  - Logs must respect redaction policies (no raw paths or secrets).
- **Counters:**
  - Track number of discrepancies vs total rows read.
  - Expose via CLI summary command `time shadow-report`.
- **Documentation:**
  - `/docs/shadow-read.md` explaining:
    - Purpose of shadow-read window.
    - How to enable/disable via flag.
    - How to interpret discrepancy logs and counters.

---

## Non-Goals
- No dropping of legacy columns (handled in PR-20).  
- No auto-correction of discrepancies (manual operator review only).  
- No UI surface; all work is backend/ops-level.  

---

## Acceptance Criteria
1. **Shadow-Read Mode:** When flag is `on`, both legacy and new values read, with discrepancies logged.  
2. **New-Only Mode:** When flag is `off`, only new UTC columns used, no shadow checks.  
3. **Discrepancy Reporting:** CLI `time shadow-report` prints totals (rows read, discrepancies found).  
4. **Logging:** Structured log lines appear with event ID and delta when mismatch detected.  
5. **Safety:** No duplicate events returned to client — output always from new UTC columns.  
6. **Tests:** Unit tests inject discrepancies and confirm detection + logging; integration tests confirm no UI-visible changes.  
7. **Documentation:** `/docs/shadow-read.md` committed with clear operator guidance.  

---

## Evidence Required in PR
- **CLI Demo:** Example output of `time shadow-report` showing counts and sample discrepancy.  
- **Log Proof:** Log excerpt with structured discrepancy record.  
- **Flag Proof:** Show app behaviour with `ARK_TIME_SHADOW_READ=on` vs `off`.  
- **Test Run:** Green run of discrepancy injection tests.  
- **Doc Proof:** `/docs/shadow-read.md` included.  

---

## Rollback Plan
- Remove shadow-read logic and feature flag.  
- Delete `time shadow-report` command.  
- Remove `/docs/shadow-read.md`.  
- Leaves system fully reliant on new UTC columns (riskier if undiscovered discrepancies exist).  

---

## PR Title / Description
- **Title:** `feat(time-shadow): add shadow-read mode with feature flag and discrepancy reporting`  
- **Body:** Must include Objective, Scope, Non-Goals, Acceptance Criteria, Evidence, and Rollback.

---
```
