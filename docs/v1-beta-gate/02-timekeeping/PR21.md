# PR-21 Mandate — Rollback & Repair Playbook

## Objective
Provide a documented and scripted **rollback/repair path** for timekeeping data.  
Ensure operators can safely recover from failed migrations, corrupted data, or unexpected timezone/recurrence issues without data loss.

---

## Scope
- **Documentation:**
  - Create `/docs/time-repair-playbook.md` containing:
    - Step-by-step rollback procedure (export, rebuild, restore).
    - Integrity checks (row counts, checksums).
    - Common failure cases and recovery strategies.
- **Scripts:**
  - Add `scripts/repair/export_time_data.sh`:
    - Exports events table (including UTC + legacy fields if present) to JSON or SQL dump.
  - Add `scripts/repair/rebuild_time_schema.sh`:
    - Creates a clean DB with the expected schema.
  - Add `scripts/repair/restore_time_data.sh`:
    - Imports data back, applying checks and rejecting malformed rows.
- **Verification:**
  - Scripted checksum step: compute and compare record counts and hash digests before and after restore.
  - Integrity check: run `PRAGMA integrity_check` and confirm no errors.
- **Testing:**
  - Rehearse full workflow on fixture DB:
    - Export → Rebuild → Restore.
    - Validate identical row counts and sample queries.
- **Documentation Addendum:**
  - Include explicit operator commands.
  - Note performance expectations for 10k/100k events.

---

## Non-Goals
- No automated correction of time drift or RRULE bugs — manual intervention required if discrepancies remain.  
- No live hotfix UI for repair — this is an operator-only process.  
- No telemetry of repair outcomes — results remain local.  

---

## Acceptance Criteria
1. **Playbook Documented:** `/docs/time-repair-playbook.md` exists, clear and step-by-step.  
2. **Scripts Added:** Export, rebuild, restore scripts exist under `/scripts/repair/`.  
3. **Checksum Verification:** Export + restore results produce identical counts and matching digests.  
4. **Integrity Proof:** `PRAGMA integrity_check` returns `ok` after restore.  
5. **Test Run:** Full rehearsal on fixture DB succeeds without data loss.  
6. **Operator Clarity:** Docs provide exact commands and expected outputs.  

---

## Evidence Required in PR
- **Doc Proof:** Contents of `/docs/time-repair-playbook.md` with rollback steps.  
- **Script Proof:** Snippet of export/rebuild/restore scripts with usage examples.  
- **Run Log:** Log from fixture DB showing export → rebuild → restore cycle.  
- **Checksum Proof:** Before/after checksum comparison in logs.  
- **Integrity Proof:** Log snippet of successful `PRAGMA integrity_check`.  

---

## Rollback Plan
- Delete `/docs/time-repair-playbook.md`.  
- Remove `scripts/repair/*`.  
- Leaves operators without a documented rollback process, but no runtime impact.  

---

## PR Title / Description
- **Title:** `docs(time-repair): add rollback and repair playbook with scripts`  
- **Body:** Must include Objective, Scope, Non-Goals, Acceptance Criteria, Evidence, and Rollback.

---
```
