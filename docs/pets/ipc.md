# Pets IPC & Validation

### Purpose

This document summarises the Tauri IPC commands that drive the Pets domain and records the validation performed in Pets PR1. The commands are generated by `gen_domain_cmds!` in `src-tauri/src/lib.rs` and expose thin CRUD wrappers over the SQLite tables described in `docs/pets/database.md`.

---

## 1. Command inventory

| Category      | Command               | Purpose                                                                                 |
| ------------- | --------------------- | --------------------------------------------------------------------------------------- |
| Pets          | `pets_list`           | List active pets (`deleted_at IS NULL`) for a household (ordered by `position, created_at, id` by default).    |
|               | `pets_get`            | Fetch a single pet row by ID.                                                           |
|               | `pets_create`         | Insert a pet row; generates `id`, `created_at`, `updated_at`.                           |
|               | `pets_update`         | Patch scalar fields (`name`, `type`, `position`, timestamps).                           |
|               | `pets_delete`         | Soft delete a pet (`deleted_at` + position renumbering).                                |
|               | `pets_restore`        | Clear `deleted_at`, bump position, and renumber siblings.                               |
| Pet Medical   | `pet_medical_list`    | List active medical records (`deleted_at IS NULL`) for a household; the UI narrows to a specific `pet_id` client side.    |
|               | `pet_medical_get`     | Fetch a single medical record by ID.                                                    |
|               | `pet_medical_create`  | Insert a medical record; cascades follow pet → household FK rules.                      |
|               | `pet_medical_update`  | Patch mutable medical fields (`description`, `relative_path`, `reminder`, etc.).        |
|               | `pet_medical_delete`  | Soft delete a medical record, cleaning up attachment metadata if present.               |
|               | `pet_medical_restore` | Restore a soft-deleted medical record (position bump not required for this table).      |
| Capabilities  | `db_has_pet_columns`  | Returns `true` when the `pets` table exists with the required `name` and `type` columns. |

All commands resolve to bare JSON values (no `{ ok, data, error }` wrapper) and emit structured traces through `tracing`; errors propagate via the standard Tauri `Result` channel.

---

## 2. Request and response shapes

The Pets commands use the `flexibleRequest` contract: payloads are permissive `Record<string, unknown>` objects. Front end helpers send camelCase keys (`householdId`, `orderBy`, `householdId`), while the backend expects the snake_case equivalents. Serde accepts both forms, so either casing is valid.

### 2.1 `pets_list`
```jsonc
// Request
{
  "householdId": "uuid",
  "orderBy": "position, created_at, id",
  "limit": 50,
  "offset": 0
}

// Response
[
  {
    "id": "pet_001",
    "name": "Skye",
    "type": "Dog",
    "household_id": "uuid",
    "created_at": 1735771800000,
    "updated_at": 1735771800000,
    "deleted_at": null,
    "position": 0
  }
]
```

### 2.2 `pets_create`
```jsonc
// Request
{
  "data": {
    "household_id": "uuid",
    "name": "Skye",
    "type": "Dog",
    "position": 0
  }
}

// Response
{
  "id": "pet_001",
  "household_id": "uuid",
  "name": "Skye",
  "type": "Dog",
  "position": 0,
  "created_at": 1735771800123,
  "updated_at": 1735771800123,
  "deleted_at": null
}
```

### 2.3 `pets_update`
```jsonc
// Request
{
  "id": "pet_001",
  "householdId": "uuid",
  "data": {
    "name": "Skye",
    "type": "Husky",
    "updated_at": 1735775400456
  }
}

// Response
null
```
`pets_delete` and `pets_restore` follow the same response shape (`null`) and require `householdId` + `id` in the request.

### 2.4 `pet_medical_create`
```jsonc
// Request
{
  "data": {
    "household_id": "uuid",
    "pet_id": "pet_001",
    "date": 1735603200000,
    "description": "Vaccination booster",
    "reminder": 1738281600000,
    "category": "pet_medical",
    "relative_path": "pets/skye/booster.pdf"
  }
}

// Response
{
  "id": "med_001",
  "household_id": "uuid",
  "pet_id": "pet_001",
  "date": 1735603200000,
  "description": "Vaccination booster",
  "reminder": 1738281600000,
  "relative_path": "pets/skye/booster.pdf",
  "category": "pet_medical",
  "created_at": 1735771800999,
  "updated_at": 1735771800999,
  "deleted_at": null,
  "document": null,
  "root_key": null
}
```

`pet_medical_update`, `pet_medical_delete`, and `pet_medical_restore` mirror the pets variants: they accept `id`, optional `householdId`, and a `data` object; responses resolve to `null` on success.

### 2.5 `db_has_pet_columns`
```jsonc
// Request
{}

// Response
true
```
The command ensures migrations have applied by checking `sqlite_master` and verifying `PRAGMA table_info('pets')` includes the `name` and `type` columns; it unlocks the capability probe logged at startup.

---

## 3. Validation pipeline

* **Front end** – Requests are issued via `petsRepo` / `petMedicalRepo` in `src/repos.ts`. Zod validation happens in higher-level flows (e.g. UI forms) but the repos themselves forward the payloads directly to `call`.
* **Backend** – `commands::create_command`, `update_command`, and `delete_command` (in `src-tauri/src/commands.rs`) enforce household scoping, run attachment guards for `pet_medical`, and maintain timestamp/position semantics. `db_has_pet_columns` inspects `sqlite_master` + `PRAGMA table_info` to confirm migrations have created the Pets tables.

---

## 4. Evidence collected in PR1

| Artefact / Output                 | Coverage                                                                                  |
| --------------------------------- | ----------------------------------------------------------------------------------------- |
| `tests/pets-schema.test.ts`       | Proves schema text parity, index presence, FK cascades, and `PRAGMA` health for Pets data. |
| Manual log review (`caps:probe`)  | Confirms `db_has_pet_columns` reports `true` with the validated schema.                   |
| `src/models.ts` alignment         | TypeScript interfaces updated to mirror SQL columns (name, type, nullability, category).  |

---

**Status:** IPC contract summary validated for Pets PR1.
**Scope:** CRUD commands for `pets` and `pet_medical`, plus the Pets capability probe.
**File:** `/docs/pets/ipc.md`

---
