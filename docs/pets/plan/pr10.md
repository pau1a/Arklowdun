# Pets PR10 ‚Äî Tests & Fixtures Hardening (P9)

### Objective

Lock the **Pets domain** into a *deterministic, repeatable test state* that verifies the entire create ‚Üí edit ‚Üí delete ‚Üí attach ‚Üí remind chain on both Intel and Apple Silicon macOS builds.

This PR guarantees consistent fixture data, stable IDs, and reliable CI runs across hardware variants.

**Done means:**

* IDs, timestamps, and order of seeded Pets and Medical records are deterministic.
* End-to-end CI passes on both Intel and Apple Silicon macOS targets.
* Full create/edit/delete/attach/remind cycle verified automatically.

---

## 1) Scope & intent

**In scope**

* Deterministic seeding for Pets and Pet Medical tables.
* NFC/NFD mixed-form Unicode name fixtures for filename and text-handling validation.
* End-to-end test coverage for all CRUD and reminder flows.
* CI matrix verification on Intel and Apple Silicon macOS runners.
* Rust + TypeScript fixture parity and documentation alignment.

**Out of scope**

* Manual or UI regression testing of non-Pets domains.
* Performance benchmarking (covered earlier in PR13 for Family).

---

## 2) Deliverables

| Deliverable       | Description                                                                              |
| ----------------- | ---------------------------------------------------------------------------------------- |
| **Seed script**   | `tools/seed/seed_pets.ts` ‚Äî generates 25 pets, 100 medical records, fixed UUIDv7 seeds.  |
| **Rust fixtures** | `tests/fixtures/pets_seed.rs` ‚Äî identical data as TS seed for backend tests.             |
| **Unicode mix**   | Include NFC + NFD pet names (‚ÄúMilo‚Äù, ‚ÄúM√≠l√≥‚Äù, ‚ÄúWhisk√©y‚Äù, ‚ÄúSkyeüêæ‚Äù) to test normalization. |
| **E2E tests**     | Playwright + Rust integration covering full CRUD + reminders.                            |
| **CI workflow**   | Add macOS Intel + ARM matrix; run seed + full suite.                                     |
| **Docs**          | Add section in `docs/pets/diagnostics.md` and `docs/pets/plan/checklist.md`.             |

---

## 3) Detailed tasks

### 3.1 Deterministic seeding (TypeScript)

Implement `tools/seed/seed_pets.ts`:

```ts
import { v7 as uuidv7 } from "uuidv7";
import { petsRepo, petMedicalRepo } from "@/repos";
import { deterministicDate, randomChoice } from "./utils";

export async function seedPets() {
  const species = ["Dog", "Cat", "Bird", "Rabbit", "Fish"];
  const names = ["Whiskey", "Skye", "Lewis", "M√≠l√≥", "T√©a", "P√©p√©", "Snowballüêæ"];
  const seededPets = [];

  for (let i = 0; i < 25; i++) {
    const id = uuidv7({ seed: i });
    const name = names[i % names.length];
    const type = species[i % species.length];
    const pet = await petsRepo.create({ id, name, type, position: i });
    seededPets.push(pet);

    for (let j = 0; j < 4; j++) {
      await petMedicalRepo.create({
        id: uuidv7({ seed: i * 100 + j }),
        pet_id: pet.id,
        date: deterministicDate(i, j),
        description: `Checkup ${j + 1}`,
        reminder: j === 0 ? Date.now() + 86400000 : null,
      });
    }
  }

  console.log("Seeded", seededPets.length, "pets with medical records");
}
```

All UUIDs derive from fixed seeds so re-running yields identical IDs and ordering.

### 3.2 Backend fixtures (Rust)

Mirror fixture creation in `tests/fixtures/pets_seed.rs`:

```rust
pub fn seed_pets(conn: &SqlitePool) -> anyhow::Result<()> {
    for i in 0..25 {
        let id = deterministic_uuid_v7(i);
        sqlx::query!("INSERT INTO pets (id, name, type, position) VALUES (?, ?, ?, ?)",
            id, seed_name(i), seed_type(i), i).execute(conn).await?;
        for j in 0..4 {
            let mid = deterministic_uuid_v7(i * 100 + j);
            let desc = format!("Checkup {}", j + 1);
            sqlx::query!("INSERT INTO pet_medical (id, pet_id, description) VALUES (?, ?, ?)",
                mid, id, desc).execute(conn).await?;
        }
    }
    Ok(())
}
```

Fixture timestamps and order are stable across platforms.

### 3.3 End-to-end test suite

Add `tests/pets_e2e.test.ts`:

**Scenarios:**

1. **Create Pet** ‚Üí assert appears in list with correct position.
2. **Edit Pet** ‚Üí rename, confirm persisted after reload.
3. **Add Medical Record** ‚Üí appears newest-first.
4. **Attach File** ‚Üí verify vault path sanitized.
5. **Set Reminder** ‚Üí verify notification fires once (mock scheduler).
6. **Delete Pet** ‚Üí cascades medical rows, list updates instantly.

Run headless Playwright with mocked permissions for notifications.

### 3.4 CI configuration

Extend `.github/workflows/ci.yml`:

```yaml
jobs:
  pets-tests:
    strategy:
      matrix:
        arch: [x64, arm64]
        os: [macos-14]
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - run: cargo test --package arklowdun --features pets
      - run: npm run test:e2e
```

Output: both Intel and ARM builds green.

### 3.5 Unicode & normalization verification

Add test asserting file creation and pet name round-trips between NFC and NFD:

```ts
expect(normalizeToNFC("M√≠l√≥") === normalizeToNFC("MiÃÅlo")).toBe(true);
```

and that vault rejects decomposed forms for duplicate paths.

---

## 4) Tests

| Category           | Coverage                                  |
| ------------------ | ----------------------------------------- |
| **Unit**           | Deterministic ID and timestamp generation |
| **Integration**    | Cascade deletes and attachment repairs    |
| **E2E**            | Full CRUD/reminder cycle                  |
| **Cross-platform** | Intel vs Apple Silicon parity             |
| **Unicode**        | NFC/NFD normalization guard               |

---

## 5) Acceptance checklist

| Condition                                  | Status | Evidence                              |
| ------------------------------------------ | ------ | ------------------------------------- |
| Deterministic seed (25 pets / 100 medical) | ‚òê      | Fixture output identical between runs |
| NFC/NFD names handled safely               | ‚òê      | Unicode normalization test passes     |
| Full CRUD + reminder E2E suite passes      | ‚òê      | CI run log                            |
| Intel + ARM macOS matrix green             | ‚òê      | GitHub Actions summary                |
| Docs updated (`plan/checklist.md`)         | ‚òê      | Commit diff                           |
| Diagnostics bundle reports stable counts   | ‚òê      | Pets section of export                |

---

## 6) Documentation updates required

| File                          | Update                                     |
| ----------------------------- | ------------------------------------------ |
| `docs/pets/diagnostics.md`    | Note new deterministic count baselines.    |
| `docs/pets/database.md`       | Add example deterministic inserts.         |
| `docs/pets/plan/checklist.md` | Include PR10 criteria.                     |
| `docs/pets/references.md`     | Add links to Unicode normalization policy. |

---

## 7) Verification workflow

1. Run seed locally:

   ```bash
   npm run seed:pets
   ```

   ‚Üí Confirm identical pet IDs across two runs.
2. Run test suite:

   ```bash
   npm run test:e2e
   cargo test --package arklowdun --features pets
   ```
3. Verify macOS CI completes both Intel & ARM jobs green.
4. Export diagnostics ‚Üí counts = 25 pets, 100 medical.
5. Open app, create/edit/delete pet ‚Üí confirm correct order, reminders fire once.

---

## 8) Risks & mitigations

| Risk                           | Mitigation                                                       |
| ------------------------------ | ---------------------------------------------------------------- |
| Random UUIDs slipping in       | Force `uuidv7(seed)` util, lint for `uuid.v4()` usage.           |
| Clock drift altering reminders | Use deterministic offset from epoch, not `Date.now()`.           |
| CI hardware variance           | Pin Node, Rust, and SQLite versions; matrix test ensures parity. |
| Unicode mismatch in FS         | Normalize filenames to NFC before vault save.                    |

---

## 9) Sign-off

| Role          | Name              | Responsibility                                  |
| ------------- | ----------------- | ----------------------------------------------- |
| **Developer** | Ged McSneggle     | Implement seed scripts, tests, and CI workflow  |
| **Reviewer**  | Paula Livingstone | Verify determinism, Unicode handling, CI parity |
| **CI**        | Automated         | macOS Intel + ARM test matrix                   |

---

**Status:** Ready for implementation
**File:** `/docs/pets/plan/pr10.md`
**Version:** 1.0
**Scope:** Deterministic fixtures and cross-hardware test stability, ensuring the Pets domain reaches full reproducibility and reliability for the macOS beta release.
